<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Flow Dashboard</title>
    <link rel="stylesheet" href="css/shared.css?v=3">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, sans-serif;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .summary-card h3 {
            margin: 0 0 0.5rem 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .summary-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .summary-card .subtext {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .alerts-section {
            margin-bottom: 2rem;
        }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .alert.critical {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--critical);
            color: var(--critical);
        }

        .alert.warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        .alert-icon {
            font-size: 1.5rem;
        }

        .transactions-section {
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            background: var(--bg-hover);
        }

        .filter-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: var(--bg-secondary);
            position: sticky;
            top: 60px;
            z-index: 10;
        }

        th {
            text-align: left;
            padding: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }

        tbody tr:nth-child(even) {
            background: var(--bg-secondary);
        }

        tbody tr:hover {
            background: var(--bg-hover);
        }

        .negative {
            color: var(--critical);
            font-weight: 600;
        }

        .positive {
            color: var(--success);
            font-weight: 600;
        }

        .low-balance {
            background: rgba(239, 68, 68, 0.05);
        }

        .last-updated {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 2rem;
            padding: 1rem;
        }

        /* Emergency Banner */
        .emergency-banner {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .emergency-content {
            display: flex;
            align-items: center;
            gap: 1rem;
            max-width: 1400px;
            width: 100%;
        }

        .emergency-icon {
            font-size: 1.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .emergency-text {
            flex: 1;
            font-weight: 600;
        }

        .emergency-action {
            padding: 0.5rem 1rem;
            background: white;
            color: #dc2626;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .emergency-action:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Glance Summary Cards */
        .glance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .glance-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .glance-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .glance-card h3 {
            margin: 0 0 0.5rem 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .glance-card .value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0.5rem 0;
        }

        .glance-card.caution {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.05);
        }

        .glance-card.caution .value {
            color: var(--warning);
        }

        .glance-context {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .trend-indicator {
            display: inline-block;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .runway-bar {
            display: block;
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .runway-fill {
            display: block;
            height: 100%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Action Center */
        .action-center {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .action-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .action-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .action-priority {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .action-main {
            margin-bottom: 1rem;
        }

        .action-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .action-why {
            font-size: 1rem;
            opacity: 0.9;
        }

        .action-alternatives {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .action-alternatives summary {
            cursor: pointer;
            font-weight: 600;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-alternatives summary::-webkit-details-marker {
            display: none;
        }

        .action-alternatives summary::before {
            content: '‚ñ∂';
            display: inline-block;
            transition: transform 0.2s;
        }

        .action-alternatives[open] summary::before {
            transform: rotate(90deg);
        }

        .action-alternatives summary:hover {
            opacity: 0.8;
        }

        /* Enhanced Alerts Section */
        .alerts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .alerts-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .alert-badges {
            display: flex;
            gap: 0.5rem;
        }

        .alert-badge {
            background: var(--critical);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .alert-badge.warning {
            background: var(--warning);
        }

        .alerts-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Chart Section */
        .chart-section {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-section h2 {
            margin: 0 0 1.5rem 0;
            font-size: 1.5rem;
        }

        #balanceChart {
            max-height: 300px;
        }
    </style>
</head>
<body>
    <nav class="top-nav">
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="dashboard.html" class="active">Dashboard</a></li>
            <li><a href="scenario-planner.html">Scenario Planner</a></li>
            <li><a href="http://localhost:8000/debt-strategy-complete.html" target="_blank">Debt Strategy</a></li>
        </ul>
    </nav>

    <!-- Emergency Banner -->
    <div class="emergency-banner" id="emergencyBanner" style="display: none;">
        <div class="emergency-content">
            <span class="emergency-icon">üö®</span>
            <div class="emergency-text">
                <strong>URGENT:</strong> Negative balance in <span id="daysUntil">5</span> days (Dec 5)
            </div>
            <button class="emergency-action" onclick="document.querySelector('.alerts-section').scrollIntoView({behavior: 'smooth'})">
                See Details
            </button>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <h1>Cash Flow Dashboard</h1>
            <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
                <span class="theme-icon" id="themeIcon">üåô</span>
                <span id="themeText">Dark</span>
            </button>
        </div>

        <!-- Glance Summary Cards -->
        <div class="glance-summary">
            <div class="glance-card" id="statusCard">
                <h3>Status</h3>
                <div class="value" id="statusValue">HEALTHY</div>
                <div class="glance-context" id="statusContext">Net positive for month</div>
            </div>
            <div class="glance-card caution">
                <h3>Next 30 Days</h3>
                <div class="value"><span id="alertCount">9</span> Alerts</div>
                <div class="glance-context">
                    <span class="trend-indicator" id="alertTrend">Monitor closely</span>
                </div>
            </div>
            <div class="glance-card" id="runwayCard">
                <h3>Cash Runway</h3>
                <div class="value">~<span id="runwayDays">18</span> days</div>
                <div class="glance-context">
                    Target: 30 days
                    <span class="runway-bar">
                        <span class="runway-fill" id="runwayFill" style="width: 60%"></span>
                    </span>
                </div>
            </div>
            <div class="glance-card" id="savingsCard">
                <h3>Disposable Income</h3>
                <div class="value"><span id="savingsRateSign">+</span><span id="savingsRate">22</span>%</div>
                <div class="glance-context">
                    <span class="trend-indicator" id="savingsContext">Income after expenses</span>
                </div>
            </div>
        </div>

        <!-- Action Center -->
        <div class="action-center" id="actionCenter">
            <div class="action-header">
                <h2>‚ö° Recommended Action</h2>
                <span class="action-priority">High Priority</span>
            </div>

            <div class="action-main">
                <div class="action-title" id="actionTitle">Transfer $800 by December 6</div>
                <div class="action-why" id="actionWhy">Prevents all 4 negative days (Dec 7-10)</div>
            </div>

            <details class="action-alternatives" id="alternativeOptionsDetails">
                <summary id="alternativeOptionsSummary">Alternative Options (0)</summary>
                <div id="alternativeOptionsList">
                    <!-- Dynamically generated options will go here -->
                </div>
            </details>
        </div>

        <div class="summary-grid" id="summaryGrid">
            <!-- Summary cards will be generated dynamically -->
        </div>

        <div class="alerts-section">
            <div class="alerts-header">
                <h2>üö® Critical Alerts</h2>
                <div class="alert-badges" id="alertBadges">
                    <!-- Alert badges will be generated dynamically -->
                </div>
            </div>
            <div class="alerts-list" id="alertsList">
                <!-- Alerts will be generated dynamically -->
            </div>
        </div>

        <div class="chart-section">
            <h2>Balance Trend</h2>
            <canvas id="balanceChart"></canvas>
        </div>

        <div class="transactions-section">
            <div class="section-header">
                <h2>Forecast</h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="negative">Negative Days</button>
                    <button class="filter-btn" data-filter="low">Low Balance</button>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Balance</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="transactionTableBody">
                    <!-- Transaction rows will be generated dynamically -->
                </tbody>
            </table>
        </div>

        <div class="last-updated">
            Last updated: Nov 21, 2025, 12:45 PM
        </div>
    </div>

    <!-- Load shared theme manager -->
    <script src="js/shared/theme-manager.js"></script>

    <!-- Load forecast data module -->
    <script src="load-forecast.js?v=7"></script>

    <!-- Load and populate dashboard with real data -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Load forecast data
            const data = await loadForecastData();
            console.log('Loaded forecast data:', data);
            console.log('Transaction count:', data.transactions ? data.transactions.length : 0);
            console.log('First 3 transactions:', data.transactions ? data.transactions.slice(0, 3) : []);

            // Populate all sections with real data
            populateGlanceCards(data);
            populateActionCenter(data);
            populateAlerts(data);
            populateSummaryCards(data);
            populateTransactionTable(data);
            populateBalanceChart(data);
            updateLastUpdated();
        });

        function populateGlanceCards(data) {
            // Calculate status based on ending balance
            const status = data.endBalance > 0 ? 'HEALTHY' : 'AT RISK';
            const statusDesc = data.endBalance > 0 ? 'Net positive for month' : 'Action needed';

            // Update STATUS card
            document.getElementById('statusValue').textContent = status;
            document.getElementById('statusContext').textContent = statusDesc;

            // Update NEXT 30 DAYS card with alert count
            const alertCount = data.alerts ? data.alerts.length : 0;
            document.getElementById('alertCount').textContent = alertCount;

            // Calculate runway (days until balance hits zero or end of forecast period)
            let runway = 30; // Default value
            if (data.forecastPeriod && data.forecastPeriod.end) {
                const currentDate = new Date();
                const endDate = new Date(data.forecastPeriod.end);
                const daysRemaining = Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24));
                runway = data.endBalance < 0 ? (data.daysNeg || daysRemaining) : daysRemaining;
            } else if (data.daysNeg) {
                runway = data.daysNeg;
            }
            document.getElementById('runwayDays').textContent = runway;

            // Update runway bar
            const runwayPercent = Math.min((runway / 30) * 100, 100);
            document.getElementById('runwayFill').style.width = runwayPercent + '%';

            // Calculate disposable income percentage
            const totalIncome = data.transactions
                .filter(t => parseFloat(t.netChange.replace(/[^0-9.-]/g, '')) > 0)
                .reduce((sum, t) => sum + Math.abs(parseFloat(t.netChange.replace(/[^0-9.-]/g, ''))), 0);
            const totalExpenses = data.transactions
                .filter(t => parseFloat(t.netChange.replace(/[^0-9.-]/g, '')) < 0)
                .reduce((sum, t) => sum + Math.abs(parseFloat(t.netChange.replace(/[^0-9.-]/g, ''))), 0);
            const disposablePercent = totalIncome > 0 ? Math.round(((totalIncome - totalExpenses) / totalIncome) * 100) : 0;
            document.getElementById('savingsRate').textContent = Math.abs(disposablePercent);
            document.getElementById('savingsRateSign').textContent = disposablePercent >= 0 ? '+' : '-';
        }

        function populateActionCenter(data) {
            // Find the most critical alert
            const negativeAlerts = data.alerts.filter(a => a.type === 'NEGATIVE' || a.type === 'NEG');
            if (negativeAlerts.length > 0) {
                const firstNegAlert = negativeAlerts[0];
                // Calculate how much to transfer (approximate from balance)
                const transferAmount = Math.abs(parseFloat(firstNegAlert.balance.replace(/[^0-9.-]/g, ''))) + 100;
                document.getElementById('actionTitle').textContent = `Transfer $${transferAmount.toFixed(0)} by ${firstNegAlert.date}`;
                document.getElementById('actionWhy').textContent = `Prevents negative balance on ${firstNegAlert.date}`;
            }
        }

        function populateAlerts(data) {
            const criticalAlerts = data.alerts.filter(a => a.type === 'NEGATIVE' || a.type === 'NEG');
            const warningAlerts = data.alerts.filter(a => a.type === 'LOW');

            // Update badge counts - only show CRITICAL badge
            const alertBadges = document.getElementById('alertBadges');
            alertBadges.innerHTML = '';
            if (criticalAlerts.length > 0) {
                alertBadges.innerHTML += `<span class="alert-badge">${criticalAlerts.length} CRITICAL</span>`;
            }
            // Removed WARNING badge per user request

            // Update alerts list
            const alertsList = document.querySelector('.alerts-list');
            alertsList.innerHTML = '';

            // Add critical alerts
            criticalAlerts.slice(0, 1).forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert critical';
                alertDiv.innerHTML = `
                    <div class="alert-icon">üö®</div>
                    <div class="alert-content">
                        <div class="alert-title">Critical Alert</div>
                        <div class="alert-message">Balance will drop below zero on ${alert.date}</div>
                    </div>
                `;
                alertsList.appendChild(alertDiv);
            });

            // Add warning alerts
            warningAlerts.slice(0, 1).forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert warning';
                alertDiv.innerHTML = `
                    <div class="alert-icon">‚ö†Ô∏è</div>
                    <div class="alert-content">
                        <div class="alert-title">Warning</div>
                        <div class="alert-message">Balance will be ${alert.balance} on ${alert.date}</div>
                    </div>
                `;
                alertsList.appendChild(alertDiv);
            });
        }

        function populateSummaryCards(data) {
            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = ''; // Clear any existing content

            // Calculate Total Income and Expenses
            const totalIncome = data.transactions
                .filter(t => parseFloat(t.netChange.replace(/[^0-9.-]/g, '')) > 0)
                .reduce((sum, t) => sum + parseFloat(t.netChange.replace(/[^0-9.-]/g, '')), 0);
            const totalExpenses = data.transactions
                .filter(t => parseFloat(t.netChange.replace(/[^0-9.-]/g, '')) < 0)
                .reduce((sum, t) => sum + Math.abs(parseFloat(t.netChange.replace(/[^0-9.-]/g, ''))), 0);

            // Find lowest balance date
            const lowestDate = data.transactions.find(t =>
                parseFloat(t.endBalance.replace(/[^0-9.-]/g, '')) === data.lowestBalance
            );

            // Card 1: Current Balance
            summaryGrid.innerHTML += `
                <div class="summary-card">
                    <h3>Current Balance</h3>
                    <p class="value">$${data.startBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                    <p class="subtext">As of ${new Date().toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}</p>
                </div>
            `;

            // Card 2: Lowest Point
            summaryGrid.innerHTML += `
                <div class="summary-card">
                    <h3>Lowest Point</h3>
                    <p class="value ${data.lowestBalance < 0 ? 'negative' : ''}">$${data.lowestBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                    <p class="subtext">On ${lowestDate ? lowestDate.date : 'Unknown'}</p>
                </div>
            `;

            // Card 3: Total Income
            summaryGrid.innerHTML += `
                <div class="summary-card">
                    <h3>Total Income</h3>
                    <p class="value positive">+$${totalIncome.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                    <p class="subtext">Next ${data.transactions.length} days</p>
                </div>
            `;

            // Card 4: Total Expenses
            summaryGrid.innerHTML += `
                <div class="summary-card">
                    <h3>Total Expenses</h3>
                    <p class="value negative">-$${totalExpenses.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                    <p class="subtext">Next ${data.transactions.length} days</p>
                </div>
            `;
        }

        function populateTransactionTable(data) {
            const tbody = document.getElementById('transactionTableBody');
            tbody.innerHTML = '';

            // Display all transactions
            data.transactions.forEach((trans, index) => {
                const row = document.createElement('tr');
                const netChange = parseFloat(trans.netChange.replace(/[^0-9.-]/g, ''));
                const endBalance = parseFloat(trans.endBalance.replace(/[^0-9.-]/g, ''));
                const isNegative = endBalance < 0;
                const isLow = endBalance > 0 && endBalance < 500;

                if (isLow || isNegative) {
                    row.classList.add('low-balance');
                }

                // Check if there are multiple transactions
                const debits = trans.debitDetails ? trans.debitDetails.split(',').map(d => d.trim()).filter(d => d) : [];
                const credits = trans.creditDetails ? trans.creditDetails.split(',').map(c => c.trim()).filter(c => c) : [];
                const hasMultiple = (debits.length + credits.length) > 1;

                let description = '';
                let expandIcon = '';

                if (netChange < 0 && debits.length > 0) {
                    description = debits[0];
                    if (debits.length > 1) {
                        expandIcon = ` <span style="color: #666; font-size: 0.9em; cursor: pointer;">+${debits.length - 1} more</span>`;
                    }
                } else if (netChange > 0 && credits.length > 0) {
                    description = credits[0];
                    if (credits.length > 1) {
                        expandIcon = ` <span style="color: #666; font-size: 0.9em; cursor: pointer;">+${credits.length - 1} more</span>`;
                    }
                } else {
                    description = 'No transactions';
                }

                const status = isNegative ? 'üö® Negative' : isLow ? '‚ö†Ô∏è Low' : '‚úì';

                row.style.cursor = hasMultiple ? 'pointer' : 'default';
                row.innerHTML = `
                    <td>${trans.date}</td>
                    <td>${description}${expandIcon}</td>
                    <td class="${netChange < 0 ? 'negative' : 'positive'}">${trans.netChange}</td>
                    <td class="${endBalance < 0 ? 'negative' : ''}">${trans.endBalance}</td>
                    <td>${status}</td>
                `;

                // Add click handler for expandable rows
                if (hasMultiple) {
                    row.addEventListener('click', () => {
                        const existingDetail = row.nextElementSibling;
                        if (existingDetail && existingDetail.classList.contains('detail-row')) {
                            // Collapse - remove detail row
                            existingDetail.remove();
                        } else {
                            // Expand - create detail row
                            const detailRow = document.createElement('tr');
                            detailRow.classList.add('detail-row');
                            detailRow.style.backgroundColor = '#f8f9fa';

                            let detailHtml = '<td colspan="5" style="padding: 15px 20px;"><div style="font-size: 0.95em;">';

                            if (debits.length > 0) {
                                detailHtml += '<strong>Debits:</strong><ul style="margin: 5px 0; padding-left: 20px;">';
                                debits.forEach(debit => {
                                    detailHtml += `<li>${debit}</li>`;
                                });
                                detailHtml += '</ul>';
                            }

                            if (credits.length > 0) {
                                detailHtml += '<strong>Credits:</strong><ul style="margin: 5px 0; padding-left: 20px;">';
                                credits.forEach(credit => {
                                    detailHtml += `<li>${credit}</li>`;
                                });
                                detailHtml += '</ul>';
                            }

                            detailHtml += '</div></td>';
                            detailRow.innerHTML = detailHtml;

                            row.after(detailRow);
                        }
                    });
                }

                tbody.appendChild(row);
            });
        }

        function populateBalanceChart(data) {
            const ctx = document.getElementById('balanceChart');

            // Prepare chart data from transactions
            const chartData = data.transactions.slice(0, 30).map(t => ({
                date: t.date.replace('2025-', '').replace('2026-', ''),
                balance: parseFloat(t.endBalance.replace(/[^0-9.-]/g, ''))
            }));

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.date),
                    datasets: [{
                        label: 'Balance',
                        data: chartData.map(d => d.balance),
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 2,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += '$' + context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateLastUpdated() {
            const now = new Date();
            const formatted = now.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            document.querySelector('.last-updated').textContent = `Last updated: ${formatted}`;
        }
    </script>


    <!-- Simple filter functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const filterButtons = document.querySelectorAll('.filter-btn');

            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update active button
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const filter = btn.dataset.filter;

                    // Query table rows dynamically (after they've been populated)
                    const tableRows = document.querySelectorAll('#transactionTableBody tr:not(.detail-row)');

                    // Show/hide rows based on filter
                    tableRows.forEach(row => {
                        if (filter === 'all') {
                            row.style.display = '';
                        } else if (filter === 'negative') {
                            const balanceCell = row.querySelector('td:nth-child(4)');
                            const isNegative = balanceCell && balanceCell.classList.contains('negative');
                            row.style.display = isNegative ? '' : 'none';
                        } else if (filter === 'low') {
                            const isLow = row.classList.contains('low-balance');
                            const balanceCell = row.querySelector('td:nth-child(4)');
                            const isNegative = balanceCell && balanceCell.classList.contains('negative');
                            // Low balance means low but NOT negative
                            row.style.display = (isLow && !isNegative) ? '' : 'none';
                        }
                    });
                });
            });
        });
    </script>
</body>
</html>
